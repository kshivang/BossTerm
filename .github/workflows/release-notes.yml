name: Generate Release Notes

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'Release tag to generate notes for (e.g., v1.0.45)'
        required: true
        type: string

permissions:
  contents: write
  id-token: write

jobs:
  generate-release-notes:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get release info
        id: release_info
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            TAG="${{ github.event.inputs.release_tag }}"
          else
            TAG="${{ github.event.release.tag_name }}"
          fi

          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "version=${TAG#v}" >> $GITHUB_OUTPUT

          # Get previous tag
          PREV_TAG=$(git describe --tags --abbrev=0 "$TAG^" 2>/dev/null || echo "")
          echo "prev_tag=$PREV_TAG" >> $GITHUB_OUTPUT

          # Get release date
          RELEASE_DATE=$(git log -1 --format=%cs "$TAG" 2>/dev/null || date +%Y-%m-%d)
          echo "release_date=$RELEASE_DATE" >> $GITHUB_OUTPUT

          echo "Current tag: $TAG"
          echo "Previous tag: $PREV_TAG"
          echo "Release date: $RELEASE_DATE"

      - name: Get commits since last release
        run: |
          TAG="${{ steps.release_info.outputs.tag }}"
          PREV_TAG="${{ steps.release_info.outputs.prev_tag }}"

          if [[ -n "$PREV_TAG" ]]; then
            git log "$PREV_TAG..$TAG" --pretty=format:"- %s" --no-merges > /tmp/commits.txt
          else
            git log "$TAG" --pretty=format:"- %s" --no-merges -20 > /tmp/commits.txt
          fi

          echo "Commits in this release:"
          cat /tmp/commits.txt

      - name: Create release notes directory
        run: mkdir -p docs/release-notes

      - name: Generate release notes with Claude
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            Generate release notes for BossTerm ${{ steps.release_info.outputs.tag }}.

            Release date: ${{ steps.release_info.outputs.release_date }}
            Previous version: ${{ steps.release_info.outputs.prev_tag }}

            Read the commits from /tmp/commits.txt and create:

            1. File: docs/release-notes/${{ steps.release_info.outputs.tag }}.md
               Format:
               # Release Notes - ${{ steps.release_info.outputs.tag }}
               **Release Date:** ${{ steps.release_info.outputs.release_date }}
               ## Highlights
               [1-2 sentence summary]
               ## New Features (if any)
               ## Bug Fixes (if any)
               ## Improvements (if any)
               ## Breaking Changes
               None (or list)
               ## Full Changelog
               https://github.com/kshivang/BossTerm/compare/${{ steps.release_info.outputs.prev_tag }}...${{ steps.release_info.outputs.tag }}

            2. Update docs/release-notes/README.md - add link to new release at top of list

            3. Run: git add docs/release-notes/ && git commit -m "docs: Add release notes for ${{ steps.release_info.outputs.tag }}" && git push

      - name: Verify and push if needed
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          TAG="${{ steps.release_info.outputs.tag }}"

          # Check if Claude already pushed
          git fetch origin master
          if git log origin/master --oneline -1 | grep -q "release notes for ${TAG}"; then
            echo "✅ Release notes already pushed by Claude"
          elif [[ -n $(git status --porcelain docs/release-notes/) ]]; then
            git add docs/release-notes/
            git commit -m "docs: Add release notes for ${TAG}"
            git push
            echo "✅ Release notes pushed"
          else
            echo "⚠️ No release notes changes found"
          fi
